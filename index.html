<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BreathScope</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f4f7;
  margin: 0;
  padding: 20px;
}
.card {
  max-width: 480px;
  margin: auto;
  background: #fff;
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 12px 28px rgba(0,0,0,0.12);
}
input, select, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0 12px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
}
button {
  background: #005fcc;
  color: white;
  border: none;
  font-size: 16px;
}
button:disabled { background: #aaa; }
small { color: #666; }
hr { margin: 20px 0; }
canvas { width: 100%; height: 150px; }
</style>
</head>

<body>
<div class="card">

<select id="lang">
  <option value="en">English</option>
  <option value="de">Deutsch</option>
</select>

<h1 id="title"></h1>
<p id="subtitle"></p>

<label id="ageLabel"></label>
<input type="number" id="age" placeholder="Years">

<label id="heightLabel"></label>
<input type="number" id="height" placeholder="cm">

<button id="startBtn"></button>

<div id="result"></div>

<div id="visualResult" style="display:none;text-align:center;">
<svg width="200" height="160" viewBox="0 0 200 160">
  <rect x="97" y="0" width="6" height="25" fill="#666"/>
  <path d="M90 20 C60 30,50 80,60 130 L90 130 Z" fill="#eee" stroke="#444"/>
  <rect id="leftFill" x="60" y="130" width="30" height="0"/>
  <path d="M110 20 C140 30,150 80,140 130 L110 130 Z" fill="#eee" stroke="#444"/>
  <rect id="rightFill" x="110" y="130" width="30" height="0"/>
</svg>
<div id="statusText" style="font-weight:bold;"></div>
</div>

<canvas id="chart"></canvas>

<hr>

<label>
  <input type="checkbox" id="clinicalMode">
  <span id="clinicalLabel"></span>
</label>

<div id="clinicalInput" style="display:none;">
  <label>Reference FEV₁ (spirometer)</label>
  <input type="number" id="refFEV1" placeholder="Liters">
</div>

<hr>
<small id="disclaimer"></small>

<hr>
<small>
© IP & Concept: <b>Moustafa Ali</b><br>
Agentic@virtualcaresolution.de<br>
dptmostafa@gmail.com
</small>

</div>

<script>
/* ---------- DOM ---------- */
const el = id => document.getElementById(id);

const lang = el("lang");
const title = el("title");
const subtitle = el("subtitle");
const ageLabel = el("ageLabel");
const heightLabel = el("heightLabel");
const startBtn = el("startBtn");
const result = el("result");
const disclaimer = el("disclaimer");
const clinicalMode = el("clinicalMode");
const clinicalInput = el("clinicalInput");
const statusText = el("statusText");

/* ---------- LANGUAGE ---------- */
const text = {
 en:{
  title:"BreathScope",
  subtitle:"Microphone-based respiratory screening",
  age:"Age",
  height:"Height",
  start:"Start Breathing Test",
  clinical:"Clinical validation mode",
  disclaimer:"Not a medical device. Screening and trend monitoring only."
 },
 de:{
  title:"BreathScope",
  subtitle:"Mikrofonbasiertes Atemfunktions-Screening",
  age:"Alter",
  height:"Körpergröße",
  start:"Atemtest starten",
  clinical:"Klinischer Validierungsmodus",
  disclaimer:"Kein Medizinprodukt. Nur Screening und Verlauf."
 }
};

function setLanguage(){
 const t = text[lang.value];
 title.textContent = t.title;
 subtitle.textContent = t.subtitle;
 ageLabel.textContent = t.age;
 heightLabel.textContent = t.height;
 startBtn.textContent = t.start;
 clinicalLabel.textContent = t.clinical;
 disclaimer.textContent = t.disclaimer;
}
lang.onchange = setLanguage;
setLanguage();

/* ---------- AUDIO ---------- */
let audioContext, analyser, dataArray, stream;
let recording = false, peak = 0;

startBtn.onclick = async () => {
 peak = 0;
 result.innerHTML = "Blow out hard for 5 seconds…";
 startBtn.disabled = true;

 audioContext = new (window.AudioContext || window.webkitAudioContext)();
 stream = await navigator.mediaDevices.getUserMedia({ audio:true });
 analyser = audioContext.createAnalyser();
 analyser.fftSize = 2048;
 dataArray = new Uint8Array(analyser.fftSize);

 audioContext.createMediaStreamSource(stream).connect(analyser);
 recording = true;
 measure();
 setTimeout(stopTest, 5000);
};

function measure(){
 if(!recording) return;
 analyser.getByteTimeDomainData(dataArray);
 let sum = 0;
 for(const v of dataArray){
  const n = (v-128)/128;
  sum += n*n;
 }
 peak = Math.max(peak, Math.sqrt(sum/dataArray.length));
 requestAnimationFrame(measure);
}

function stopTest(){
 recording = false;
 startBtn.disabled = false;
 stream.getTracks().forEach(t => t.stop());

 const age = +el("age").value || 40;
 const height = +el("height").value || 170;

 const pef = peak * 800;
 const fev1 = pef * 0.004 * (height/170) * (40/age);
 const expected = 0.04*height - 0.03*age - 2;
 const pct = Math.max(0, Math.min(100, fev1/expected*100));

 let color = pct<50?"#f44336":pct<80?"#ffc107":"#4caf50";
 statusText.textContent =
  pct<50?"Markedly reduced (relative)":
  pct<80?"Reduced (relative)":"Within expected range";

 ["leftFill","rightFill"].forEach(id=>{
  const r = el(id);
  const h = 110*pct/100;
  r.setAttribute("y",130-h);
  r.setAttribute("height",h);
  r.setAttribute("fill",color);
 });

 el("visualResult").style.display="block";

 result.innerHTML = `
 <b>Estimated Results</b><br>
 PEF (relative): ${pef.toFixed(0)}<br>
 FEV₁ (estimated): ${fev1.toFixed(2)} L<br>
 FEV₁ (% expected): ${pct.toFixed(0)}%
 `;
 saveTrend(fev1);
 drawChart();
}

/* ---------- TREND ---------- */
function saveTrend(v){
 const d = JSON.parse(localStorage.getItem("breathscope")||"[]");
 d.push({t:Date.now(),v});
 localStorage.setItem("breathscope",JSON.stringify(d));
}

function drawChart(){
 const c = el("chart");
 const ctx = c.getContext("2d");
 const d = JSON.parse(localStorage.getItem("breathscope")||"[]");
 const r = devicePixelRatio || 1;
 c.width = c.clientWidth * r;
 c.height = 150 * r;
 ctx.scale(r,r);
 ctx.clearRect(0,0,c.width,c.height);
 if(d.length<2) return;
 const max = Math.max(...d.map(x=>x.v));
 ctx.beginPath();
 d.forEach((p,i)=>{
  const x=i/(d.length-1)*c.clientWidth;
  const y=150-(p.v/max)*130;
  i?ctx.lineTo(x,y):ctx.moveTo(x,y);
 });
 ctx.strokeStyle="#005fcc";
 ctx.lineWidth=2;
 ctx.stroke();
}

clinicalMode.onchange=()=>clinicalInput.style.display=
 clinicalMode.checked?"block":"none";
</script>
</body>
</html>
